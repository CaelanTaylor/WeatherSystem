<!DOCTYPE html>
<html>
    <head>
        <title>1 Hour Wind Trend</title>
        <link rel="stylesheet" href="style.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <div class="navbar">
            <div class="logo">
                <h1>WindScout</h1>
            </div>
            <div class="navitems">
                <ul>
                    <li><a href="index.html">LiveWeather</a></li>
                    <li><a href="10mtrend.html">10 Minute Trend</a></li>
                    <li><a href="1htrend.html"><b>1 Hour Trend</b></a></li>
                    <li><a href="analysis.html">Analysis</a></li>
                    <li><a href="settings.html">Settings</a></li>
                </ul>
            </div>
            <button class="menu-toggle" onclick="toggleMenu()">☰</button>
        </div>
        <div class="content">
            <div class="title">
                <h1>1 Hour Trend</h1>
                <div class="line"></div>
                <p id="trend-location" style="font-size: 1.2em; margin-top: 10px;"></p>
            </div>
        </div>
        <br>
        <br>
        <div class="dashboard">
            <div>
                <canvas id="avgWindChart" width="400" height="200"></canvas>
            </div>
            <div>
                <canvas id="gustChart" width="400" height="200"></canvas>
            </div>
            <div>
                <canvas id="dirChart" width="400" height="200"></canvas>
            </div>
        </div>
        <script>
            // NEW: Function to fetch and display the current location
            async function fetchLocation() {
                try {
                    const response = await fetch('/get_settings');
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('trend-location').textContent = `Location: ${data.location}`;
                    }
                } catch (error) {
                    console.error("Error fetching location:", error);
                    document.getElementById('trend-location').textContent = "Location: (Unknown)";
                }
            }
            
            let avgWindChart = null;
            let gustChart = null;
            let dirChart = null;

            async function drawTrendGraphs() {
                try {
                    const response = await fetch('/trend1h'); // Fetches data filtered by location
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (data.error) {
                         console.error("API Error:", data.error);
                         return;
                    }

                    const labels = data.map(item => item.time);
                    const avgWind = data.map(item => item.avg_wind);
                    const maxGust = data.map(item => item.max_gust);
                    const avgDir = data.map(item => item.avg_dir);

                    const windOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Wind Speed (knots)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            }
                        }
                    };

                    // Average Wind Chart
                    if (!avgWindChart) {
                        avgWindChart = new Chart(document.getElementById('avgWindChart'), {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Average Wind Speed (knots)',
                                    data: avgWind,
                                    borderColor: 'blue',
                                    fill: false
                                }]
                            },
                            options: windOptions
                        });
                    } else {
                        avgWindChart.data.labels = labels;
                        avgWindChart.data.datasets[0].data = avgWind;
                        avgWindChart.options = windOptions;
                        avgWindChart.update();
                    }

                    // Highest Gust Chart
                    if (!gustChart) {
                        gustChart = new Chart(document.getElementById('gustChart'), {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Highest Gust (knots)',
                                    data: maxGust,
                                    borderColor: 'red',
                                    fill: false
                                }]
                            },
                            options: windOptions
                        });
                    } else {
                        gustChart.data.labels = labels;
                        gustChart.data.datasets[0].data = maxGust;
                        gustChart.options = windOptions;
                        gustChart.update();
                    }

                    // Average Direction Chart
                    if (!dirChart) {
                        dirChart = new Chart(document.getElementById('dirChart'), {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Average Direction (°)',
                                    data: avgDir,
                                    borderColor: 'green',
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        min: 0,
                                        max: 360,
                                        title: {
                                            display: true,
                                            text: 'Direction (Degrees)'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Time'
                                        }
                                    }
                                }
                            }
                        });
                    } else {
                        dirChart.data.labels = labels;
                        dirChart.data.datasets[0].data = avgDir;
                        dirChart.update();
                    }
                } catch (error) {
                    console.error("Error fetching trend data:", error);
                }
            }

            function toggleMenu() {
                document.querySelector('.navitems').classList.toggle('open');
            }

            // Initial load and periodic updates
            fetchLocation();
            drawTrendGraphs();
            setInterval(drawTrendGraphs, 5000); // Auto update every 5 seconds
        </script>
    </body>
</html>